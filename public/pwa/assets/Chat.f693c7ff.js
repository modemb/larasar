import{y as X,c as d,h as o,a9 as $,bb as ee,bc as ae,aw as te,r as u,aR as se,o as oe,w as j,af as b,am as M,al as x,b9 as J,f,an as H,K as ne,ak as S,ah as le,ag as T,ap as ie,F as re,aq as G,ay as ce,ao as me}from"./index.d6c95a7b.js";import{a as ue,Q as de}from"./QBar.fe849e49.js";import{a as ve,b as ge}from"./QLayout.8583c076.js";import{Q as fe,a as he}from"./QFooter.eca9f0a6.js";import{Q as be}from"./QSeparator.8817dad6.js";import{Q as pe,C as ye}from"./ClosePopup.0c5fb872.js";import{u as xe}from"./use-quasar.cb55fe1d.js";import{u as Ce,a as O,t as ke,d as we}from"./axios.3202fc3e.js";import{_ as _e}from"./plugin-vue_export-helper.21dcd24c.js";import"./use-dark.b9235899.js";import"./i18n.31f4444f.js";var Me=X({name:"QChatMessage",props:{sent:Boolean,label:String,bgColor:String,textColor:String,name:String,avatar:String,text:Array,stamp:String,size:String,labelHtml:Boolean,nameHtml:Boolean,textHtml:Boolean,stampHtml:Boolean},setup(s,{slots:n}){const i=d(()=>s.sent===!0?"sent":"received"),a=d(()=>`q-message-text-content q-message-text-content--${i.value}`+(s.textColor!==void 0?` text-${s.textColor}`:"")),p=d(()=>`q-message-text q-message-text--${i.value}`+(s.bgColor!==void 0?` text-${s.bgColor}`:"")),C=d(()=>"q-message-container row items-end no-wrap"+(s.sent===!0?" reverse":"")),l=d(()=>s.size!==void 0?`col-${s.size}`:""),c=d(()=>({msg:s.textHtml===!0?"innerHTML":"textContent",stamp:s.stampHtml===!0?"innerHTML":"textContent",name:s.nameHtml===!0?"innerHTML":"textContent",label:s.labelHtml===!0?"innerHTML":"textContent"}));function y(r){return n.stamp!==void 0?[r,o("div",{class:"q-message-stamp"},n.stamp())]:s.stamp?[r,o("div",{class:"q-message-stamp",[c.value.stamp]:s.stamp})]:[r]}function h(r,m){const g=m===!0?r.length>1?v=>v:v=>o("div",[v]):v=>o("div",{[c.value.msg]:v});return r.map((v,q)=>o("div",{key:q,class:p.value},[o("div",{class:a.value},y(g(v)))]))}return()=>{const r=[];n.avatar!==void 0?r.push(n.avatar()):s.avatar!==void 0&&r.push(o("img",{class:`q-message-avatar q-message-avatar--${i.value}`,src:s.avatar,"aria-hidden":"true"}));const m=[];n.name!==void 0?m.push(o("div",{class:`q-message-name q-message-name--${i.value}`},n.name())):s.name!==void 0&&m.push(o("div",{class:`q-message-name q-message-name--${i.value}`,[c.value.name]:s.name})),n.default!==void 0?m.push(h($(n.default()),!0)):s.text!==void 0&&m.push(h(s.text)),r.push(o("div",{class:l.value},m));const g=[];return n.label!==void 0?g.push(o("div",{class:"q-message-label"},n.label())):s.label!==void 0&&g.push(o("div",{class:"q-message-label",[c.value.label]:s.label})),g.push(o("div",{class:C.value},r)),o("div",{class:`q-message q-message-${i.value}`},g)}}});const Se=[o("circle",{cx:"15",cy:"15",r:"15"},[o("animate",{attributeName:"r",from:"15",to:"15",begin:"0s",dur:"0.8s",values:"15;9;15",calcMode:"linear",repeatCount:"indefinite"}),o("animate",{attributeName:"fill-opacity",from:"1",to:"1",begin:"0s",dur:"0.8s",values:"1;.5;1",calcMode:"linear",repeatCount:"indefinite"})]),o("circle",{cx:"60",cy:"15",r:"9","fill-opacity":".3"},[o("animate",{attributeName:"r",from:"9",to:"9",begin:"0s",dur:"0.8s",values:"9;15;9",calcMode:"linear",repeatCount:"indefinite"}),o("animate",{attributeName:"fill-opacity",from:".5",to:".5",begin:"0s",dur:"0.8s",values:".5;1;.5",calcMode:"linear",repeatCount:"indefinite"})]),o("circle",{cx:"105",cy:"15",r:"15"},[o("animate",{attributeName:"r",from:"15",to:"15",begin:"0s",dur:"0.8s",values:"15;9;15",calcMode:"linear",repeatCount:"indefinite"}),o("animate",{attributeName:"fill-opacity",from:"1",to:"1",begin:"0s",dur:"0.8s",values:"1;.5;1",calcMode:"linear",repeatCount:"indefinite"})])];var qe=X({name:"QSpinnerDots",props:ee,setup(s){const{cSize:n,classes:i}=ae(s);return()=>o("svg",{class:i.value,fill:"currentColor",width:n.value,height:n.value,viewBox:"0 0 120 30",xmlns:"http://www.w3.org/2000/svg"},Se)}});const Qe={name:"App",props:["roomId"],setup(s){const n=xe(),i=Ce(),{crudAction:a,notifyAction:p}=i,C=te(),l=u([]),c=u(""),y=u(!1),h=u(!1),r=u(!1),m=u([]),g=u(null),v=u(""),q=u(null),U=u(0),D=u(n.platform.is.mobile),B=d(()=>i.authGetter),L=d(()=>i.chatUserGetter),k=d(()=>C.params.id||s.roomId),V=d(()=>{var e;return(e=i.configGetter)==null?void 0:e.ipDebug}),K="api/messages",N=5e3,Y=navigator.userAgent.match(/(modembIos)/),F=()=>U.value=screen.height/(V.value?1:Y?1.23:1),Q=e=>h.value=e;se(()=>m.value=[]),oe(()=>z());function z(){Z(),F(),window.onresize=F,window.Echo.channel(`App.Models.Room.${k.value}`).listen("MessageSent",async t=>{var R,w,_,E;a({notify:(R=C.path)==null?void 0:R.includes(`/chat/${t.roomId}`),mutate:"notifyGetter",refresh:["notifyGetter"]}).then(W=>{});const A=((w=L.value)==null?void 0:w.id)===(t==null?void 0:t.userId);((_=B.value)==null?void 0:_.id)!==(t==null?void 0:t.userId)&&(Q(!t.message),t!=null&&t.received?y.value=!Q(!1):I({received:!0,room_id:t.roomId}),setTimeout(()=>Q(!1),N),(E=l.value)==null||E.push({typing:t.typing,message:t.message,room_id:t.roomId,user:A?L.value:await a({url:`api/users/${t.userId}`,method:"get",getUser:!0,mutate:"chatUserGetter",refresh:["chatUserGetter"]}).catch(W=>p({error:"userListening",e:W}))})),n.cookies.get("notReceived")!=="notReceived"&&setTimeout(()=>!t.message||y.value||I({notReceived:!0,emailMessage:t.message,emailRoomId:t.roomId}),N)})}j(k,()=>z());function Z(){O.get(`${K}/${k.value}?messages=1`).then(({data:e})=>{l.value=e.messages,v.value=e.name,q.value=e.link}).catch(e=>p({error:"fetchMessages",e}))}function I(e){var t;return e.notReceived&&n.cookies.set("notReceived","notReceived",{expires:"1h"}),(t=l.value)==null||t.push(e),O.post(K,e)}function P(e){var w,_;const A="vertical",R=(_=(w=m.value)==null?void 0:w[e-1])==null?void 0:_.offsetTop;g.value.setScrollPosition(A,R,0)}return j(()=>m.value.length,e=>P(e)),{position:m,timeago:ke,scrollAreaRef:g,newMessage:c,messages:l,roomName:v,mobile:D,link:q,scroll:P,onload:z,col:D.value||s.roomId?"col-12":"col-8",height:U,listening:h,darkMode:d(()=>{var e;return(e=i.darkModeGetter)!=null&&e.darkMode?"q-dark":"bg-white"}),ipDebug:V,authCheck:e=>{var t;return((t=B.value)==null?void 0:t.id)===(e==null?void 0:e.id)},chatting(e){console.log("key",e.key),(!e.key||e.key!=="Enter")&&!r.value&&I({typing:e.key,room_id:k.value}).then(()=>r.value=!0).catch(t=>p({error:"typing",e:t})),setTimeout(()=>r.value=Q(!1),N)},sendMessage(){c.value&&I({message:c.value,user:B.value,room_id:k.value}).catch(e=>p({error:"sendMessage",e})),c.value=""},avatar(e){var t;return e!=null&&e.avatar?e!=null&&e.avatar.includes("files/")?we+"/"+e.avatar:e==null?void 0:e.avatar:(t=e==null?void 0:e.new)==null?void 0:t.avatar},thumbStyle:{right:"4px",borderRadius:"5px",backgroundColor:"#027be3",width:"5px",opacity:.25},barStyle:{right:"2px",borderRadius:"9px",backgroundColor:"#027be3",width:"9px",opacity:.2}}}},Ie={class:"flex flex-center q-ma-sm row"},Re={key:1,class:"text-green fa-solid fa-check-double float-right"};function He(s,n,i,a,p,C){return b(),M(ve,{view:"lHh lpr lFf",container:"",style:J(`height:${a.height/1.35}px`),class:"shadow-2 rounded-borders"},{default:x(()=>[f(ge,{elevated:""},{default:x(()=>[f(ue,null,{default:x(()=>[f(H,{label:a.mobile?"":a.roomName,icon:"fas fa-undo",to:a.link},null,8,["label","to"]),f(de),i.roomId?ne((b(),M(H,{key:0,dense:"",flat:"",icon:"close"},null,512)),[[ye]]):S("",!0)]),_:1})]),_:1}),le("div",Ie,[f(fe,{ref:"scrollAreaRef",class:G(a.col+" q-mt-lg"),style:J(`height:${a.height/1.6}px`),"thumb-style":a.thumbStyle,"bar-style":a.barStyle},{default:x(()=>[(b(!0),T(re,null,ie(a.messages,(l,c)=>{var y;return b(),T("div",{key:c,ref_for:!0,ref:h=>{h&&(a.position[c]=h)}},[l.message?(b(),M(Me,{key:0,avatar:a.avatar(l.user),sent:a.authCheck(l.user),text:[l.message],name:a.authCheck(l.user)?"me":(y=l.user)==null?void 0:y.first_name,stamp:a.timeago(l.updated_at)},null,8,["avatar","sent","text","name","stamp"])):S("",!0),a.ipDebug&&a.authCheck(l.user)?(b(),T("i",Re)):S("",!0),a.messages.length-1===c&&a.listening?(b(),M(qe,{key:2,size:"2rem"})):S("",!0)])}),128))]),_:1},8,["class","style","thumb-style","bar-style"]),f(be,{dark:""}),a.ipDebug?(b(),M(H,{key:0,flat:"",label:a.height},null,8,["label"])):S("",!0),f(he,{class:G(a.darkMode),elevated:""},{default:x(()=>[f(pe,{clearable:"",outlined:"",modelValue:a.newMessage,"onUpdate:modelValue":n[0]||(n[0]=l=>a.newMessage=l),onKeydown:a.chatting,class:G(a.col),onKeyup:ce(a.sendMessage,["enter"]),label:s.$t("Send Message")},{append:x(()=>[f(H,{flat:"",icon:"fas fa-paper-plane",onClick:me(a.sendMessage,["prevent"])},null,8,["onClick"])]),_:1},8,["modelValue","onKeydown","class","onKeyup","label"])]),_:1},8,["class"])])]),_:1},8,["style"])}var Fe=_e(Qe,[["render",He],["__scopeId","data-v-f5be62a6"]]);export{Fe as default};
